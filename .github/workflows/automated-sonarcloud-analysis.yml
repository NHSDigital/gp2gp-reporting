name: "Z-AUTOMATED: SonarCloud-Analysis"
on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  sonarcloud:
    name: SonarCloud
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Shallow clones should be disabled for a better relevancy of analysis

      - name: Use Node.js 24.x
        uses: actions/setup-node@v6
        with:
          node-version: 24.x
          cache: "npm"
          cache-dependency-path: dashboard/package-lock.json

      - name: Set up Python 3.14
        uses: actions/setup-python@v6
        with:
          python-version: 3.14

      - name: Install pipenv
        run: python -m pip install --upgrade pip pipenv

      - name: Install Python dependencies and run tests with coverage
        shell: bash
        run: |
          set -euo pipefail
          for pipfile in services/*/Pipfile; do
            svc_dir="$(dirname "$pipfile")"
            echo "== Testing $svc_dir =="

            export PIPENV_PIPFILE="$pipfile"

            if [ ! -f "${svc_dir}/Pipfile.lock" ]; then
              pipenv lock
            fi
            pipenv sync --dev

            pipenv run pytest "${svc_dir}/tests" \
              --cov="${svc_dir}" \
              --cov-report="xml:${svc_dir}/coverage.xml"
          done

      - name: Install Dashboard Typescript dependencies and run tests with coverage
        working-directory: dashboard
        run: |
          npm ci
          npm test -- --coverage

      - name: SonarQube Cloud Scan
        uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9 # v7.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
